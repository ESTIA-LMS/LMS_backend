<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/auth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/auth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code> /**
 * Module pour le controller d'authentification. {@link class:auth_ctrl}
 * @module auth/controller
 */

const httpError = require('http-errors')
const bcrypt = require('bcrypt')
const jwt = require('jsonwebtoken')

const User = require('../models/Users');

/**
 * Controller pour l'authentification.
 * @class auth_ctrl Authentication controller
 */

 const auth_ctrl = {}

/**
* Méthode pour la connexion / authentification de l'utilisateur.
* @param  {Request}  req Argument de requête HTTP à la fonction
* @param  {Response} res Argument de réponse HTTP à la fonction
* @param  {function} next Argument d'appel à la fonction middleware suivante dans l’application.
*/

auth_ctrl.login = function login(req,res,next){

    let {email, mdp} = req.body

    if(!email || !mdp){
        throw next(httpError(400, 'Paramètre manquant')) 
    }

    User.findOne({where:{Users_Email : email}, raw: true})
        .then(user => {

            //vérf user existe avec ce mail
            if(user === null){
                return res.status(401).json({message: `Email n'existe pas`})
            }


            //vérif du mdp
            bcrypt.compare(mdp, user.Users_Pwd)
                .then(match => {

                    if(!match){
                        return res.status(401).json({message: `Mauvais mot de passe`})
                    }

                    //Si test ok alros génération du token
                    const token = jwt.sign({
                        id: user.Users_Id,
                        nom: user.Users_Nom,
                        prenom: user.Users_Prenom
                    }, process.env.JWT_PHRASE_SECRETE, {expiresIn: '365 days'})

                    return res.status(200).json({access_token: token})
                })
                .catch(next)
        })
        .catch(err => res.status(500).json({message: `Le processus de connexion a échoué`}))
}


/**
* Méthode pour update le mot de passe utilisateur.
* @param  {Request}  req Argument de requête HTTP à la fonction
* @param  {Response} res Argument de réponse HTTP à la fonction
* @param  {function} next Argument d'appel à la fonction middleware suivante dans l’application.
*/

auth_ctrl.updateMdp = function update(req, res, next) {

    const id = req.params.id
    const {oldPwd, newPwd, newPwdConf} = req.body
  
    if (!Number(id)) return res.status(400).json({message:'On est mal barré'})
  
    //verif mdp identiques
    if(newPwd !== newPwdConf) return res.status(400).json({message:'les mots de passe ne sont pas identiques'})
  
    //verif conforme rgpd
    if(newPwd.length&lt;=6)  return res.status(400).json({message:`Veuillez saisir un mdp d'au moins 6 charactère`})
  
    //Cherche user
    User.findOne({where:{Users_Id: id}, raw: true})
    .then(user => {
  
        //vérf user existe avec ce num
        if(user === null) return res.status(401).json({message: `Cet utilisateur n'existe pas`})
  
        //verif old mdp
        bcrypt.compare(oldPwd, user.Users_Pwd)
        .then(match => {

          if(!match) return res.status(401).json({message: `Ancien mot de passe ne correspond pas.`})
                    
          //Si ok alors hashage puis mdp update
          bcrypt.hash(newPwd, 10)
              .then(hash => {
                  //Update le mdp
                  User.update({Users_Pwd: hash}, {where:{Users_Id: id}, raw: true})
                      .then(user => res.status(200).json({message : 'Mdp mis à jour'}))
                      .catch(err => res.status(500).json({message : 'erreur update mdp'}))
              })
              .catch(err => res.status(500).json({message: 'Erreur hashage'}))
        })
        .catch(err => res.status(500).json({message: 'Erreur comparaison'}))
    })
    .catch(err => res.status(401).json({message: 'Erreur recherche utilisateur'}))
}

module.exports = auth_ctrl</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-auth_controller.html">auth/controller</a></li><li><a href="module-user_controller.html">user/controller</a></li></ul><h3>Classes</h3><ul><li><a href="module-auth_controller-auth_ctrl.html">auth_ctrl</a></li><li><a href="module-user_controller-user_ctrl.html">user_ctrl</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Thu Apr 14 2022 13:31:02 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
